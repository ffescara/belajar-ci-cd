name: CI/CD VPS multi env

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Deploy to DEV over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          # port: ${{ secrets.SSH_PORT }}   # kalau pakai port custom, tambahkan baris ini
          script: |
            set -e

            echo "Deploying DEV from main branch"

            # ðŸ‘‰ load nvm & pakai Node 24
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 24

            cd ${{ secrets.APP_DIR }}

            git fetch --all
            git reset --hard origin/main

            # install deps untuk production
            npm ci --omit=dev

            pm2 reload ecosystem.config.cjs --only belajar-ci-cd-dev || pm2 start ecosystem.config.cjs --only belajar-ci-cd-dev
            pm2 save

  # deploy-staging:
  #   needs: deploy-dev
  #   runs-on: ubuntu-latest
  #   environment: staging
  #   steps:
  #     - name: Deploy to STAGING over SSH
  #       uses: appleboy/ssh-action@v1.1.0
  #       with:
  #         host: ${{ secrets.SSH_HOST }}
  #         username: ${{ secrets.SSH_USER }}
  #         key: ${{ secrets.SSH_KEY }}
  #         # port: ${{ secrets.SSH_PORT }}
  #         script: |
  #           set -e

  #           echo "Deploying STAGING from main branch"

  #           export NVM_DIR="$HOME/.nvm"
  #           [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
  #           nvm use 24

  #           cd ${{ secrets.APP_DIR }}

  #           git fetch --all
  #           git reset --hard origin/main

  #           npm ci --omit=dev

  #           pm2 reload ecosystem.config.cjs --only belajar-ci-cd-staging || pm2 start ecosystem.config.cjs --only belajar-ci-cd-staging
  #           pm2 save

  # deploy-production:
  #   needs: deploy-staging
  #   runs-on: ubuntu-latest
  #   environment:
  #     name: production
  #     url: http://your-production-url.example.com
  #   steps:
  #     - name: Deploy to PRODUCTION over SSH
  #       uses: appleboy/ssh-action@v1.1.0
  #       with:
  #         host: ${{ secrets.SSH_HOST }}
  #         username: ${{ secrets.SSH_USER }}
  #         key: ${{ secrets.SSH_KEY }}
  #         # port: ${{ secrets.SSH_PORT }}
  #         script: |
  #           set -e

  #           echo "Deploying PRODUCTION from main branch"

  #           export NVM_DIR="$HOME/.nvm"
  #           [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
  #           nvm use 24

  #           cd ${{ secrets.APP_DIR }}

  #           git fetch --all
  #           git reset --hard origin/main

  #           npm ci --omit=dev

  #           pm2 reload ecosystem.config.cjs --only belajar-ci-cd-prod || pm2 start ecosystem.config.cjs --only belajar-ci-cd-prod
  #           pm2 save
